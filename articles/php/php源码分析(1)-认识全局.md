---
title: php源码分析(1)-认识全局
date: 2015-11-26
tags:
- php
- php源码
---
### 前言 ###
早在13年底就有了研究php内核源码的想法，当时苦于C语言相关知识已趋于生疏，加之网上php内核相关资料非常稀少便暂时放下了。今年因工作上需要，动手修改了一个php扩展taint并萌生了深入php内核源码的冲动，这半年来一边了解nginx实现，一边恶补了C和linux系统相关知识，正是万事具备，只欠东风!

回想自己在阅读过程中查阅资料的辛苦，便想着将自己的笔记整理成__《php源码分析系列》__博文以供后来者参照，疏漏不严谨甚至错误恐怕在所难免的，各位读者如发现需更正之处，请不吝指教(联系方式:dzthink#qq.com)。

### 开篇约定 ###
此文为系列开篇，从宏观上阐述整个php生命周期，为避免陷入细节洪流（以后逐步深入，各个击破），约定如下:

>**1. 文中所使用的代码均为php5.6**

>**2. 以cli执行模式为例(执行环境最为干净)**

>**3. 关注流程，弱化细节(比如如何解析命令行参数...)**

>**4. 无视线程安全相关内容(略去所有ZTS宏定义部分)**

>**5. linux阵营的死忠，所以别问为什么没有windows相关内容**


### php架构 ###
先来看下php架构图(图片来源于laruence大神博客):

[![php架构图](../img/php-arch-293x300.jpg)](http://www.laruence.com/2008/08/12/180.html)

上图清晰的表达了php内核的层次结构，从上至下依次为SAPI、PHP、Zend API、Zend Engine(Application部分已经不是php范畴了)，下面分别简述下各层的功能划分

**Sapi(SAPI.h:220)**——Server Application Programing Interface（ 服务器端应用编程接口），这里接口是广义上的接口（不是面向对象中Interface），我们可以称之为约定。sapi是上层应用程序和php之间通信方式约定——配置信息，环境信息，请求参数，结果输出，系统初始化和系统关闭等。

**PHP**——可能这里比较迷惑（又一个PHP，are you kidding？），之所以称这里为php，我想是因为我们平时所看到使用到的php语言特性，功能基本上都是通过这一层暴露出来的。

**ZEND_API**——像sapi一样，ZEND_API定义了php层如何和zend引擎通信，当然这里的api要相对具体些，实际上是zend引擎向外提供的一些列函数来访问其内部组件和各种状态数据。

**ZEND**——相信这个东西对于每个php开发者来说都是如雷贯耳了，实际上zend是伴随着php4才出现的，它是当仁不让的php核心，提供语言级别的基础设施。
### php生命周期 ###
生命周期是什么就不在赘述了,如下图所示,其中MINIT——模块初始化，RINIT——模块请求初始化，SCRIPT——编译执行脚本，RSHUTDOWN-模块请求关闭，MSHUTDOWN——模块关闭

![单进程生命周期](../img/2012_02_02_05.jpg)
![多线程生命周期](../img/2012_02_02_06.jpg)

### 启动阶段 ###
这一阶段为后面的请求处理，脚本编译执行准备环境，涉及到大量的全局变量，全局函数指针，各种数据结构初始化，下面是我认为启动过程中比较重要的一些步骤：

* 启动zend，这恐怕是整个启动阶段最为重要的一步了，这一步初始化了内存管理器、opcode处理函数表、编译执行相关的函数指针、运行时的全局函数表，类表，自动全局变量表，常量表，注册了编译进php的模块等等

* 启动gc，此处仅仅是初始化了gc_globals变量
* php配置文件解析（php\_init\_config）,这是一个长达350行的函数，除了冗长的目录地址处理和搜索外，php配置文件解析最值得注意的是zend\_parse\_ini\_file函数，跟踪这个函数实现会发现它定义在zend\_ini\_parser.y的文件中，这个正是bison(php使用的语法分析器)的语法描述文件。所以简单来说，php的配置文件解析是使用词法分析器和语法分析器完成的（感觉有点杀鸡用牛刀的感觉）。
* 加载编译到php内核模块，php扩展，zend扩展并逐一完成模块初始化工作(MINIT)

### 请求初始化阶段 ###

* 这一阶段是对应每个独立的请求的，所完成的工作用两个字概括来说就是**重置**——重置编译器，执行器;重置各个扩展模块(RINIT)；重置输出栈；重置请求相关数据结构；
###编译执行阶段###
毫无疑问，这一阶段就是将传入的php脚本编译成opcode，然后开始按顺序执行的过程。当然编译和执行是交替出现的，比如出现执行事遇到include语句时就会停下来编译并执行引入的脚本。如下图所示：

![php执行流程](../img/php执行流程.png)

这一阶段是php最为核心的部分，这里不再展开来讲了，后面会有专门文章详细探讨这一部分内容
### 总结 ###
整个php核心部分归结来所干了三件事情：

1. 编译：将php源码编译为opcode（zend_op_array)
2. 执行：将上述opcode序列按顺序执行
3. 执行上述两项功能所需要的基础环境(外部信息交换，基本数据结构，内存管理，线程安全...)

### 结语 ###
这篇文章断断续续的写了几个星期，实在很难把握其详略程度，很多细节现在也不是很明了，但把所有内容都弄清楚再回来把内容写出来又不是我的风格（那时可能就没有写的出来的兴趣和必要了）。还是使用迭代的概念吧，先来个粗糙(甚至包含错漏)的版本，等后面详细了解每一个组成部分的时候再不断的雕琢。
